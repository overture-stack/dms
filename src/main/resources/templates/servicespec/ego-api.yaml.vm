# For more info on the api, refer to:
#  SwaggerEditor: https://editor.swagger.io/
#  OpenAPI: https://docs.docker.com/engine/api/v1.40.yaml
# All durations are in nanotime
Name: ego-api
TaskTemplate:
  ContainerSpec:
    Image: "overture/ego:3.6.0"
    Env:
    - SERVER_PORT=8080
    - SPRING_FLYWAY_ENABLED=true
    - SPRING_FLYWAY_LOCATIONS=classpath:flyway/sql,classpath:db/migration
    - SPRING_PROFILES_ACTIVE=auth,grpc,jwt
    - SPRING_DATASOURCE_USERNAME=postgres
    - SPRING_DATASOURCE_PASSWORD=$dmsConfig.ego.databasePassword
    - SPRING_DATASOURCE_URL=jdbc:postgresql://${composeServiceResources.EGO_DB.toString()}:5432/ego?stringtype=unspecified
    - SWAGGER_HOST=$dmsConfig.ego.serverUrl.host:$dmsConfig.ego.serverUrl.port
    - SWAGGER_BASEURL=#if($dmsConfig.ego.serverUrl.path == '')/#{else}$dmsConfig.ego.serverUrl.path#end
#if( $dmsConfig.clusterRunMode == 'LOCAL')
    - LOGIN_NONCE_SECURE=false
    - LOGIN_NONCE_SAMESITE=lax
#end
    - INITIALIZATION_ENABLED=true
    - INITIALIZATION_APPLICATIONS_0_NAME=$dmsConfig.ego.uiAppCredentials.name
    - INITIALIZATION_APPLICATIONS_0_TYPE=ADMIN
    - INITIALIZATION_APPLICATIONS_0_CLIENTID=$dmsConfig.ego.uiAppCredentials.clientId
    - INITIALIZATION_APPLICATIONS_0_CLIENTSECRET=$dmsConfig.ego.uiAppCredentials.clientSecret
    - INITIALIZATION_APPLICATIONS_0_REDIRECTURI=$dmsConfig.ego.uiAppCredentials.redirectUri
#if( $dmsConfig.ego.dmsAppCredentials )
    - INITIALIZATION_APPLICATIONS_1_NAME=$dmsConfig.ego.dmsAppCredentials.name
    - INITIALIZATION_APPLICATIONS_1_TYPE=ADMIN
    - INITIALIZATION_APPLICATIONS_1_CLIENTID=$dmsConfig.ego.dmsAppCredentials.clientId
    - INITIALIZATION_APPLICATIONS_1_CLIENTSECRET=$dmsConfig.ego.dmsAppCredentials.clientSecret
#end
    - REFRESHTOKEN_COOKIEISSECURE=true
    - REFRESHTOKEN_DOMAIN=$dmsConfig.ego.serverUrl.host
    - APITOKEN_DURATIONDAYS=$dmsConfig.ego.apiTokenDurationDays
    - JWT_USER_DURATIONMS=$dmsConfig.ego.jwt.user.durationMs
    - JWT_APP_DURATIONMS=$dmsConfig.ego.jwt.app.durationMs
    - REFRESHTOKEN_DURATIONMS=$dmsConfig.ego.refreshTokenDurationMS
#if( $dmsConfig.ego.sso.google )
    - GOOGLE_CLIENT_CLIENTID=$dmsConfig.ego.sso.google.clientId
    - GOOGLE_CLIENT_CLIENTSECRET=$dmsConfig.ego.sso.google.clientSecret
    - GOOGLE_CLIENT_PREESTABLISHEDREDIRECTURI=$dmsConfig.ego.sso.google.preEstablishedRedirectUri
#end
#if( $dmsConfig.ego.sso.github )
    - GITHUB_CLIENT_CLIENTID=$dmsConfig.ego.sso.github.clientId
    - GITHUB_CLIENT_CLIENTSECRET=$dmsConfig.ego.sso.github.clientSecret
    - GITHUB_CLIENT_PREESTABLISHEDREDIRECTURI=$dmsConfig.ego.sso.github.preEstablishedRedirectUri
#end
#if( $dmsConfig.ego.sso.linkedin )
    - LINKEDIN_CLIENT_CLIENTID=$dmsConfig.ego.sso.linkedin.clientId
    - LINKEDIN_CLIENT_CLIENTSECRET=$dmsConfig.ego.sso.linkedin.clientSecret
    - LINKEDIN_CLIENT_PREESTABLISHEDREDIRECTURI=$dmsConfig.ego.sso.linkedin.preEstablishedRedirectUri
#end
#if( $dmsConfig.ego.sso.facebook )
    - FACEBOOK_CLIENT_CLIENTID=$dmsConfig.ego.sso.facebook.clientId
    - FACEBOOK_CLIENT_CLIENTSECRET=$dmsConfig.ego.sso.facebook.clientSecret
    - FACEBOOK_CLIENT_PREESTABLISHEDREDIRECTURI=$dmsConfig.ego.sso.facebook.preEstablishedRedirectUri
#end
#if( $dmsConfig.ego.sso.orcid )
    - ORCID_CLIENT_CLIENTID=$dmsConfig.ego.sso.orcid.clientId
    - ORCID_CLIENT_CLIENTSECRET=$dmsConfig.ego.sso.orcid.clientSecret
    - ORCID_CLIENT_PREESTABLISHEDREDIRECTURI=$dmsConfig.ego.sso.orcid.preEstablishedRedirectUri
#end
    Mounts: null
    Duration: null
    StopGracePeriod: 120000000000
    DNSConfig: null
    OpenStdin: false
    ReadOnly: false
    Hosts: null
    Hostname: null
    Secrets: null
    HealthCheck: null
    StopSignal: "SIGINT"
    Privileges: null
    Configs: null
  Resources:
    Limits:
      #2 GiB
      MemoryBytes: 2147483648
      #unlimited.
      NanoCPUs: 0
    Reservations:
      #1.5 GiB
      MemoryBytes: 1610612736
      #unlimited.
      NanoCPUs: 0
  RestartPolicy:
    Condition: "on-failure"
    # 10s
    Delay: 10000000000
    MaxAttempts: 0
    # unbounded
    Window: 0
  Placement: null
  LogDriver:
    Name: "json-file"
    Options: null
  ForceUpdate: 0
  Networks:
    - Target: "dms-network"
      Aliases: null
  Runtime: null
Mode:
  Replicated:
    Replicas: 1
  Global: null
UpdateConfig:
  FailureAction: "rollback"
  #Since there is a shared volume, containing process information
  # need to ensure its stopped first
  Order: "start-first"
  Parallelism: null
  Delay: null
  MaxFailureRatio: null
  Monitor: null
RollbackConfig:
  FailureAction: "continue"
  #Since there is a shared volume, containing process information
  # need to ensure its stopped first
  Order: "start-first"
  Parallelism: null
  Delay: null
  MaxFailureRatio: 0.8
  Monitor: null
Networks:
  - Target: "dms-network"
    Aliases: null
EndpointSpec:
  Mode: "vip"
  Ports:
    - Name: "api"
      Protocol: "tcp"
      TargetPort: 8080
      PublishedPort: $dmsConfig.ego.apiHostPort
      PublishMode: "ingress"
Labels: null

